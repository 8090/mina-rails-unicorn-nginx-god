<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Mina+Rails+Unicorn+Nginx+God by alfuken</title>
    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="javascripts/respond.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!--[if lt IE 8]>
    <link rel="stylesheet" href="stylesheets/ie.css">
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

  </head>
  <body>
      <div id="header">
        <nav>
          <li class="fork"><a href="https://github.com/alfuken/mina-rails-unicorn-nginx-god">View On GitHub</a></li>
          <li class="downloads"><a href="https://github.com/alfuken/mina-rails-unicorn-nginx-god/zipball/master">ZIP</a></li>
          <li class="downloads"><a href="https://github.com/alfuken/mina-rails-unicorn-nginx-god/tarball/master">TAR</a></li>
          <li class="title">DOWNLOADS</li>
        </nav>
      </div><!-- end header -->

    <div class="wrapper">

      <section>
        <div id="title">
          <h1>Mina+Rails+Unicorn+Nginx+God</h1>
          <p>An example deployment configuration using Mina for server running Rails app, Unicorn, nginx, and God.</p>
          <hr>
          <span class="credits left">Project maintained by <a href="https://github.com/alfuken">alfuken</a></span>
          <span class="credits right">Hosted on GitHub Pages &mdash; Theme by <a href="http://twitter.com/#!/michigangraham">mattgraham</a></span>
        </div>

        <h1>Mina + Rails + Unicorn + nginx + God</h1>

<h1></h1>

<p>An example deployment configuration using <a href="https://github.com/nadarei/mina">Mina</a> for deployment.</p>

<p>Deploys and updates Rails application and config files for <a href="http://unicorn.bogomips.org/">Unicorn</a>, <a href="http://wiki.nginx.org/Main">nginx</a>, and <a href="http://godrb.com/">God</a>.</p>

<h2>Why?</h2>

<p>When I've started using Mina for deployment, these examples were what I needed most.</p>

<p>Not to just copy and use, but also to read and understand.</p>

<p>After a few days of tinkering I've come up with this setup.</p>

<p>So I thought, why not share? I hope it can be useful for somebody, so that one can see, learn, understand, and use.</p>

<h2>How?</h2>

<p>This example assumes the following:</p>

<ul>
<li>you're running Ubuntu in Vagrant locally (quite nice tool I'd say. Check out <a href="http://railscasts.com/episodes/292-virtual-machines-with-vagrant">RBates Railscast</a> on this subject)</li>
<li>you already have a user, that will be running deployment and all the server stuff</li>
<li>this user have sudo privileges OR you have a separate user that have sudo privileges. You'll need sudoer for setup_extras and config:link tasks. If you don't have separate sudoer, script will assume that deployer have all the necessary sudo rights. If you know workaround, please, let me know about it!</li>
<li>you already installed and configured git, rvm (global installation preferred) and nginx, at least</li>
<li>probably something else I forgot at the moment. Don't expect flawless deploy from scratch anyway</li>
</ul><p>Example deployment to local vagrant virtual machine:</p>

<div class="highlight"><pre><span class="c"># copy config/deploy.rb to $YOUR_APP/config/deploy.rb</span>
<span class="c"># copy lib/mina to $YOUR_APP/lib</span>
<span class="c"># edit common settings and anything you like in config/deploy.rb</span>
<span class="c"># edit lib/mina/servers/*.rb to match your server configuration</span>
mina init
mina setup          <span class="c"># Set up deploy server with paths, configs, etc. Requires sudo privileges or sudoer user</span>
mina deploy
mina nginx:restart  <span class="c"># or nginx:start</span>
mina god:start      <span class="c"># it will also run unicorn automagically</span>
</pre></div>

<p>You should be up and running now. Yay!</p>

<p>All tasks by default will run for :default_server, which is :vagrant in this example. See config/deploy.rb lines 22 and 28-29
When you'll need to run the same for production, add <code>to=server_config_name</code>, like this:</p>

<div class="highlight"><pre>mina init <span class="nv">to</span><span class="o">=</span>production
mina setup <span class="nv">to</span><span class="o">=</span>production
mina deploy <span class="nv">to</span><span class="o">=</span>production
mina nginx:restart <span class="nv">to</span><span class="o">=</span>production
mina god:start <span class="nv">to</span><span class="o">=</span>production
</pre></div>

<p><code>mina deploy to=production</code> sounds just right. :) Thanks <a href="http://github.com/rstacruz">@rstacruz</a> for the hint!
You can, of course, set the :default_server to anything you like.</p>

<p><code>setup</code> task also invokes these additional tasks:</p>

<div class="highlight"><pre>create_extra_paths
god:setup
god:upload
unicorn:upload
nginx:upload
</pre></div>

<p>and if you don't set separate sudoer user, these tasks invoked as well, implying that current user have sudo rights (if he doesn't, you'll be prompted to run 'sudo_setup' task, which does exactly that):</p>

<div class="highlight"><pre>god:link
unicorn:link
nginx:setup
nginx:link
</pre></div>

<p>You can, of course, run them one by one. And you will eventually do so, if you find yourself in need of modifying some config files.</p>

<h2>What now?</h2>

<p>You can check God status:</p>

<pre><code>mina god:status
</code></pre>

<p>...or overall processes' status/health:</p>

<pre><code>mina health
</code></pre>

<p>You can customize output of this command in lib/mina/extras.rb:33</p>

<p><strong>NB!</strong> If you're running FreeBSD, do <code>set :term_mode, :exec</code> and after running Mina make sure you have no bash zombies, running around, eating your CPU. Just in case...</p>

<p>To deploy next release, just run</p>

<pre><code>mina deploy
</code></pre>

<p>If you've changed some of the config files for god/unicorn/nginx, you can upload them to server with <code>mina config:upload</code>.</p>

<p>If changed code includes unicorn or god control script (service), you will also need to run <code>mina config:link</code>, that requires sudo privileges. Keep in mind, that any nginx controlling task also requires sudo! Those are: stop, start, restart, reload, and status.</p>

<p>Individual tasks are also available, like <code>god:upload</code>, or <code>unicorn:link</code>.</p>

<p>You can as well run <code>mina god:parse:unicorn</code> to see how god's unicorn config file will look like without uploading it to server. Very useful for debugging!</p>

<p>Just check out task files under lib/mina directory, most of the code there is quite self-explanatory!</p>

<h2>Man, this code sucks!</h2>

<p>Probably. But it is the code I'm currently using for production deployment, and if you think you can improve
it or just have a better idea regarding anything described here - send me an email or pull request.</p>

<h2>Me</h2>

<ul>
<li><a href="http://alfuken.tumblr.com/">Blog</a></li>
<li><a href="http://twitter.com/alfuken">Twitter</a></li>
<li><a href="https://github.com/alfuken">Github</a></li>
<li><a href="http://alfuken.github.com/mina-rails-unicorn-nginx-god/">Github Page</a></li>
</ul>
      </section>

    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
    
  </body>
</html>